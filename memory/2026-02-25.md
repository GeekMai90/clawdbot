# 2026-02-25 记忆

## 记忆系统大升级（下午会话）

### 背景
麦先生在微信群里分享 OpenClaw memory 结构，引发讨论，随后深入研究并完成了整套记忆系统重构。

### 联网抓取最佳实践（重要）
- `web_fetch` 在沙盒里因 IP 检查被拦，**改用 curl + Jina Reader**
- `curl -s --max-time 30 -H "User-Agent: Mozilla/5.0" "https://r.jina.ai/https://目标URL"`
- 已写入 memory/core.md 和 TOOLS.md，以后默认使用此方案

### 研究了三篇外部文章（通过 curl+Jina 抓取）
1. Milvus memsearch — 把 OpenClaw memory 架构独立开源，强调 Markdown 为 source of truth + Milvus 向量索引
2. Daily Dose of DS — 批评 OpenClaw memory 只有文本相似度没有关系理解，推荐 Cognee 知识图谱插件
3. OpenViking（字节火山引擎）— 专为 AI Agent 设计的上下文数据库，L0/L1/L2 三层 + 文件系统范式 + 自动蒸馏，最对口

### OpenViking 的启发
- L0/L1/L2 三层：Abstract（~100 token）/ Overview（~2k token）/ Details（完整）
- 文件系统范式：`viking://user/memories/` + `viking://agent/memories/`
- 会话结束自动蒸馏：记忆自进化
- 目录递归检索：比平铺向量检索更精准

### 记忆系统重构（5 件事 + 3 件改进，共 8 件全部完成）

**第一轮（5件）：**
1. 新建 `memory/core.md`（893字节 L0 层，每次必读）
2. TOOLS.md 瘦身：30KB → 3.7KB（技能手册迁回各自 SKILL.md）
3. 每周日 22:00 全量蒸馏 cron（`80eda33e`，已成功手动触发验证）
4. 日志归档机制：`memory/_archive/` + `archive-old-logs.sh`
5. MEMORY.md 重写：21KB → 6.4KB，去重 + 置顶核心 + 状态标记

**第二轮（3件，参考 OpenViking）：**
6. Memory 目录分区：新建 `memory/user-prefs.md`（用户偏好）+ `memory/agent-notes.md`（Agent 经验），MEMORY.md 变为 1.2KB 纯索引
7. 每日凌晨 01:00 轻量蒸馏 cron（`771183eb`，静默，不发消息，写入分区文件）
8. 各分区文件每章节加 `>` 摘要行（提升 qmd 检索精准度）

**最终文件大小：**
- MEMORY.md: 2KB（索引）
- memory/core.md: 1.7KB（L0）
- memory/user-prefs.md: 1.6KB（用户偏好）
- memory/agent-notes.md: 4.8KB（Agent 经验）
- TOOLS.md: 4.6KB（精简版）

### 每周记忆蒸馏首次运行
- 手动触发 `weekly_memory_distill`，运行 4分31秒
- MEMORY.md 新增 4 条历史遗漏内容（Cron chatId 教训、bookmark-organizer、notion-topic、Discord 接入状态）

### 文档输出
- 撰写并保存到 Obsidian：`07-工具/OpenClaw教程/OpenClaw 分层记忆系统设计与搭建指南.md`
- 包含：架构设计、优势分析、与 OpenViking 对比、8 步搭建提示词

### 当前记忆架构（最终态）
```
L0 HOT     memory/core.md           每次必读（< 2KB）
L1 WARM    memory/user-prefs.md     用户偏好分区
           memory/agent-notes.md    Agent 经验分区
           MEMORY.md               索引（< 2KB）
L2 COLD    memory/YYYY-MM-DD.md    近 30 天日志
           memory/_archive/         归档
```

### 自动维护链路
- 每天 01:00 → 轻量蒸馏（静默）
- 每周日 22:00 → 全量蒸馏 + 归档 + Telegram 汇报
- 每天 03:00 → GitHub 私有仓库备份
